{% extends 'base.html.twig' %}

{% block title %}Shopping Cart | B2Battle Electronics{% endblock %}

{% block body %}
<!-- Cart Header -->
<section class="py-16 relative overflow-hidden">
    <!-- Background Effects -->
    <div class="absolute inset-0 bg-gradient-to-r from-orange-500/10 via-transparent to-red-500/10"></div>
    <div class="absolute top-0 left-1/4 w-64 h-64 bg-orange-500/20 rounded-full blur-3xl animate-float"></div>
    <div class="absolute bottom-0 right-1/4 w-64 h-64 bg-red-500/20 rounded-full blur-3xl animate-float" style="animation-delay: -2s;"></div>
    
    <div class="container mx-auto px-4 relative z-10">
        <!-- Header -->
        <div class="text-center mb-12">
            <h1 class="text-5xl font-bold bg-gradient-to-r from-orange-400 to-red-500 bg-clip-text text-transparent mb-4">
                Shopping Cart
            </h1>
            <p class="text-xl text-gray-300">
                Review your items before checkout
            </p>
        </div>

        <!-- Validation Errors -->
        {% if validation_errors is not empty %}
            <div class="max-w-4xl mx-auto mb-8">
                {% for error in validation_errors %}
                    <div class="bg-yellow-500/20 border border-yellow-500/50 text-yellow-300 px-4 py-3 rounded-xl mb-4">
                        {{ error }}
                    </div>
                {% endfor %}
            </div>
        {% endif %}

        <!-- Cart Content -->
        <div class="max-w-6xl mx-auto">
            {% if cart_items is empty %}
                <!-- Empty Cart -->
                <div class="bg-gray-900/80 backdrop-blur-xl rounded-3xl p-12 border border-gray-800 text-center">
                    <div class="w-24 h-24 bg-gradient-to-r from-gray-600 to-gray-700 rounded-full flex items-center justify-center mx-auto mb-6">
                        <i data-lucide="shopping-cart" class="w-12 h-12 text-gray-400"></i>
                    </div>
                    <h3 class="text-2xl font-bold text-white mb-4">Your Cart is Empty</h3>
                    <p class="text-gray-400 mb-8">Add some amazing electronics to get started!</p>
                    <a href="{{ path('app_products') }}" class="inline-flex items-center space-x-2 px-8 py-4 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl text-white font-bold hover:shadow-lg hover:shadow-orange-500/25 transition-all duration-300 transform hover:scale-105">
                        <i data-lucide="shopping-bag" class="w-5 h-5"></i>
                        <span>Continue Shopping</span>
                    </a>
                </div>
            {% else %}
                <!-- Cart Items -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <!-- Items List -->
                    <div class="lg:col-span-2 space-y-6">
                        <div class="bg-gray-900/80 backdrop-blur-xl rounded-2xl p-6 border border-gray-800">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                                <i data-lucide="package" class="w-6 h-6 mr-3 text-orange-400"></i>
                                Cart Items ({{ cart_items|length }})
                            </h2>

                            <div class="space-y-4" id="cart-items">
                                {% for item in cart_items %}
                                    <div class="cart-item bg-gray-800/50 rounded-xl p-4 border border-gray-700" data-product-id="{{ item.product.id }}">
                                        <div class="flex items-center space-x-4">
                                            <!-- Product Image -->
                                            <div class="flex-shrink-0">
                                                {% if item.product.imageUrl %}
                                                    <img src="{{ item.product.imageUrl }}" alt="{{ item.product.name }}" class="w-20 h-20 rounded-lg object-cover">
                                                {% else %}
                                                    <div class="w-20 h-20 bg-gray-700 rounded-lg flex items-center justify-center">
                                                        <i data-lucide="image" class="w-8 h-8 text-gray-400"></i>
                                                    </div>
                                                {% endif %}
                                            </div>

                                            <!-- Product Details -->
                                            <div class="flex-1">
                                                <h3 class="text-lg font-semibold text-white mb-1">{{ item.product.name }}</h3>
                                                <p class="text-gray-400 text-sm mb-2">{{ item.product.description|slice(0, 100) }}...</p>
                                                <p class="text-orange-400 font-bold text-lg">₹{{ item.unit_price|number_format(2) }}</p>
                                            </div>

                                            <!-- Quantity Controls -->
                                            <div class="flex items-center space-x-3">
                                                <button onclick="updateQuantity({{ item.product.id }}, {{ item.quantity - 1 }})" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-white transition-colors">
                                                    <i data-lucide="minus" class="w-4 h-4"></i>
                                                </button>
                                                <span class="w-12 text-center text-white font-semibold">{{ item.quantity }}</span>
                                                <button onclick="updateQuantity({{ item.product.id }}, {{ item.quantity + 1 }})" class="w-8 h-8 bg-gray-700 hover:bg-gray-600 rounded-lg flex items-center justify-center text-white transition-colors">
                                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                                </button>
                                            </div>

                                            <!-- Item Total -->
                                            <div class="text-right">
                                                <p class="text-white font-bold text-lg">₹{{ item.total_price|number_format(2) }}</p>
                                                <button onclick="removeFromCart({{ item.product.id }})" class="text-red-400 hover:text-red-300 text-sm mt-1 transition-colors">
                                                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-1"></i>
                                                    Remove
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>

                            <!-- Cart Actions -->
                            <div class="flex flex-col sm:flex-row gap-4 mt-6 pt-6 border-t border-gray-700">
                                <a href="{{ path('app_products') }}" class="flex-1 py-3 px-6 bg-gray-800/50 border border-gray-700 rounded-xl text-white text-center font-medium hover:bg-gray-700/50 transition-all duration-300">
                                    <i data-lucide="arrow-left" class="w-4 h-4 inline mr-2"></i>
                                    Continue Shopping
                                </a>
                                <button onclick="clearCart()" class="flex-1 py-3 px-6 bg-red-500/20 text-red-400 rounded-xl font-medium hover:bg-red-500/30 transition-all duration-300">
                                    <i data-lucide="trash-2" class="w-4 h-4 inline mr-2"></i>
                                    Clear Cart
                                </button>
                            </div>
                        </div>
                    </div>

                    <!-- Order Summary -->
                    <div class="lg:col-span-1">
                        <div class="bg-gray-900/80 backdrop-blur-xl rounded-2xl p-6 border border-gray-800 sticky top-24">
                            <h2 class="text-2xl font-bold text-white mb-6 flex items-center">
                                <i data-lucide="calculator" class="w-6 h-6 mr-3 text-green-400"></i>
                                Order Summary
                            </h2>

                            <div class="space-y-4 mb-6" id="cart-summary">
                                <div class="flex justify-between text-gray-300">
                                    <span>Subtotal ({{ cart_summary.count }} items)</span>
                                    <span>₹{{ cart_summary.subtotal|number_format(2) }}</span>
                                </div>
                                
                                <div class="flex justify-between text-gray-300">
                                    <span>Tax (GST 18%)</span>
                                    <span>₹{{ cart_summary.tax|number_format(2) }}</span>
                                </div>
                                
                                <div class="flex justify-between text-gray-300">
                                    <span>Shipping</span>
                                    {% if cart_summary.free_shipping_eligible %}
                                        <span class="text-green-400">FREE</span>
                                    {% else %}
                                        <span>₹{{ cart_summary.shipping|number_format(2) }}</span>
                                    {% endif %}
                                </div>

                                {% if not cart_summary.free_shipping_eligible %}
                                    <div class="bg-blue-500/20 border border-blue-500/50 rounded-lg p-3">
                                        <p class="text-blue-300 text-sm">
                                            <i data-lucide="truck" class="w-4 h-4 inline mr-1"></i>
                                            Add ₹{{ (500 - cart_summary.subtotal)|number_format(2) }} more for FREE shipping!
                                        </p>
                                    </div>
                                {% endif %}

                                <div class="border-t border-gray-700 pt-4">
                                    <div class="flex justify-between text-white text-xl font-bold">
                                        <span>Total</span>
                                        <span>₹{{ cart_summary.total|number_format(2) }}</span>
                                    </div>
                                </div>
                            </div>

                            <!-- Checkout Button -->
                            <a href="{{ path('app_checkout') }}" class="w-full py-4 bg-gradient-to-r from-orange-500 to-red-500 rounded-2xl text-white font-bold text-lg text-center block hover:shadow-lg hover:shadow-orange-500/25 transition-all duration-300 transform hover:scale-105">
                                <i data-lucide="credit-card" class="w-5 h-5 inline mr-2"></i>
                                Proceed to Checkout
                            </a>

                            <!-- Security Badge -->
                            <div class="mt-4 text-center">
                                <p class="text-gray-400 text-sm flex items-center justify-center">
                                    <i data-lucide="shield-check" class="w-4 h-4 mr-1 text-green-400"></i>
                                    Secure Checkout
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            {% endif %}
        </div>
    </div>
</section>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Lucide icons
    lucide.createIcons();
});

function updateQuantity(productId, quantity) {
    if (quantity < 1) {
        removeFromCart(productId);
        return;
    }

    fetch(`/cart/update/${productId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-Requested-With': 'XMLHttpRequest'
        },
        body: `quantity=${quantity}`
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert(data.message || 'Failed to update cart');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        alert('An error occurred while updating the cart');
    });
}

function removeFromCart(productId) {
    if (confirm('Are you sure you want to remove this item from your cart?')) {
        fetch(`/cart/remove/${productId}`, {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to remove item');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while removing the item');
        });
    }
}

function clearCart() {
    if (confirm('Are you sure you want to clear your entire cart?')) {
        fetch('/cart/clear', {
            method: 'POST',
            headers: {
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                location.reload();
            } else {
                alert(data.message || 'Failed to clear cart');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('An error occurred while clearing the cart');
        });
    }
}
</script>
{% endblock %}
